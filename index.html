<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Fund Expenditures</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #4a5568;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            font-size: 20px;
            font-weight: 600;
        }
        .download-btn {
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .download-btn:hover {
            background: #38a169;
        }
        .content {
            padding: 20px 30px;
        }
        .filters {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .filter-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .filter-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .filter-select:hover {
            border-color: #4299e1;
        }
        .filter-select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .action-btn {
            padding: 10px 20px;
            background: white;
            color: #4a5568;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .action-btn:hover {
            border-color: #4299e1;
            color: #4299e1;
        }
        .action-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        .action-btn.download {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
        }
        .action-btn.download:hover {
            background: #38a169;
            border-color: #38a169;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #718096;
        }
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            padding: 20px;
            background: #fed7d7;
            color: #c53030;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š General Fund Expenditures - July & August 2025</h1>
            <button class="download-btn" onclick="downloadFiltered()">â¬‡ Download CSV</button>
        </div>
        <div class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div>Loading data...</div>
            </div>
            <div id="error" style="display: none;"></div>
            <div id="filters" class="filters" style="display: none;">
                <div class="filter-group">
                    <label class="filter-label">Department</label>
                    <select id="deptFilter" class="filter-select">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Expense Category</label>
                    <select id="objectFilter" class="filter-select">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Rows per page</label>
                    <select id="pageSizeSelect" class="filter-select">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="250">250</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                    </select>
                </div>
                <button id="toggleColumns" class="action-btn" onclick="toggleAllColumns()">
                    Show All Columns
                </button>
                <button class="action-btn download" onclick="downloadFiltered()">
                    â¬‡ Download CSV
                </button>
            </div>
            <div id="table"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://storage.googleapis.com/intelechia-content/metro-budget-data/general%20fund/General%20Fund%2010101%20July%20and%20August%202025%20Expenditures%20-%20PRR%2001936525(Data).csv';
        
        let tableData = [];
        let table = null;
        let showingAllColumns = false;

        // Priority columns to show by default
        const priorityColumns = [
            'Department',
            'Total',
            'GL Date',
            'Explanation',
            'Address Book Name',
            'Object Account Descr',
            'Invoice Number',
            'Invoice Date',
            'Payment Date',
            'PO #'
        ];

        // Department mapping - FY2026 Complete List
        const deptMapping = {
            "00": "Metro Council",
            "01": "Vice Mayor",
            "03": "Office of the Mayor",
            "04": "Department of Law",
            "05": "Planning Department",
            "06": "Election Commission",
            "07": "Finance Department",
            "09": "Register of Deeds",
            "10": "Department of General Services",
            "11": "Historical Commission",
            "12": "Codes Department",
            "13": "Nashville Public Library",
            "14": "Parks and Recreation",
            "15": "Public Health Department",
            "16": "Police Department",
            "19": "Fire Department",
            "20": "Water and Sewer Services",
            "21": "Public Works / NDOT",
            "22": "Waste Services Division",
            "24": "Department of Transportation (WeGo/Transit Authority)",
            "25": "Emergency Communications (911)",
            "26": "Emergency Management",
            "27": "Information Technology Services",
            "30": "Assessor of Property",
            "31": "County Clerk",
            "32": "Trustee",
            "33": "Property Standards / Codes Administration",
            "35": "Legal Services",
            "36": "Metro Development and Housing Agency",
            "39": "Juvenile Court",
            "40": "General Sessions Court",
            "41": "Criminal Court Clerk",
            "45": "Circuit Court Clerk",
            "46": "Chancery Court",
            "50": "District Attorney General",
            "51": "Public Defender",
            "52": "Metro Action Commission",
            "53": "Office of Homeless Services",
            "54": "Social Services",
            "55": "Office of Family Safety",
            "56": "Hospital Authority",
            "57": "Behavioral Health / Supportive Services",
            "58": "Office of Emergency Management",
            "59": "Human Resources",
            "60": "Metro Employee Benefits Board",
            "61": "Department of Human Relations",
            "62": "Department of Housing",
            "63": "Convention Center Authority",
            "64": "Sports Authority",
            "65": "Nashville Farmers' Market",
            "66": "Metropolitan Nashville Arts Commission",
            "67": "State Fairgrounds Nashville",
            "70": "Department of Education / MNPS",
            "71": "Charter Schools Administration",
            "72": "Davidson County Sheriff's Office",
            "73": "Justice Integration Services",
            "75": "Metro Transit Authority / WeGo Public Transit",
            "78": "Metro Airport Authority",
            "80": "Convention and Visitors Corporation",
            "81": "Human Relations Commission",
            "82": "Metropolitan Clerk's Office",
            "83": "Internal Audit",
            "85": "Office of Transportation Licensing Commission",
            "90": "Industrial Development Board",
            "91": "Economic and Community Development",
            "92": "Metro Housing Trust Fund Commission",
            "96": "Four Percent Reserve Fund",
            "99": "Finance / Contingency Reserve"
        };

        function extractDeptCode(row) {
            if (row['Business Unit']) {
                const bu = String(row['Business Unit']);
                return bu.slice(-2);
            }
            
            if (row['Account Number']) {
                const accountNum = String(row['Account Number']);
                const firstDot = accountNum.indexOf('.');
                if (firstDot >= 2) {
                    return accountNum.substring(firstDot - 2, firstDot);
                }
            }
            
            return null;
        }

        async function loadData() {
            try {
                console.log('Loading from:', CSV_URL);
                
                // Download CSV content directly
                const csvResponse = await fetch(CSV_URL);
                
                if (!csvResponse.ok) {
                    throw new Error(`Failed to fetch CSV: ${csvResponse.status}`);
                }
                
                const csvText = await csvResponse.text();
                console.log('Parsing CSV...');
                
                // Parse CSV
                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                console.log('Rows parsed:', parsed.data.length);

                // Add department info
                tableData = parsed.data.map(row => {
                    const deptCode = extractDeptCode(row);
                    const deptName = deptCode ? (deptMapping[deptCode] || 'Unknown') : 'Unknown';
                    
                    return {
                        'Department': deptName,
                        ...row
                    };
                });

                displayData();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.style.display = 'block';
                errorDiv.className = 'error';
                errorDiv.innerHTML = `Error: ${error.message}<br><br>Check console for details.`;
            }
        }

        function displayData() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('filters').style.display = 'flex';
            
            console.log('Creating table with', tableData.length, 'rows');
            console.log('Sample row:', tableData[0]);

            // Get all unique departments for filter
            const departments = [...new Set(tableData.map(row => row.Department))].sort();
            const deptFilter = document.getElementById('deptFilter');
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });

            // Get all unique object account descriptions for filter
            const objectAccounts = [...new Set(tableData.map(row => row['Object Account Descr']).filter(x => x))].sort();
            const objectFilter = document.getElementById('objectFilter');
            objectAccounts.forEach(obj => {
                const option = document.createElement('option');
                option.value = obj;
                option.textContent = obj;
                objectFilter.appendChild(option);
            });

            // Get all column names from first row
            const allColumns = Object.keys(tableData[0]);
            
            // Create column definitions
            const columns = allColumns.map(col => ({
                title: col,
                field: col,
                visible: priorityColumns.includes(col)
            }));

            // Create table
            table = new Tabulator("#table", {
                data: tableData,
                columns: columns,
                layout: "fitData",
                pagination: true,
                paginationSize: 50,
                movableColumns: true,
                resizableColumns: true
            });

            // Add department filter listener
            deptFilter.addEventListener('change', applyFilters);
            objectFilter.addEventListener('change', applyFilters);

            // Add page size selector
            document.getElementById('pageSizeSelect').addEventListener('change', function() {
                table.setPageSize(parseInt(this.value));
            });
        }

        function applyFilters() {
            const deptValue = document.getElementById('deptFilter').value;
            const objectValue = document.getElementById('objectFilter').value;
            
            const filters = [];
            if (deptValue) {
                filters.push({field: 'Department', type: '=', value: deptValue});
            }
            if (objectValue) {
                filters.push({field: 'Object Account Descr', type: '=', value: objectValue});
            }
            
            if (filters.length > 0) {
                table.setFilter(filters);
            } else {
                table.clearFilter();
            }
        }

        function toggleAllColumns() {
            showingAllColumns = !showingAllColumns;
            const btn = document.getElementById('toggleColumns');
            
            if (showingAllColumns) {
                // Show all columns
                const allColumns = table.getColumns();
                allColumns.forEach(col => {
                    col.show();
                });
                btn.textContent = 'Show Essential Columns';
                btn.classList.add('active');
            } else {
                // Hide non-priority columns
                const allColumns = table.getColumns();
                allColumns.forEach(col => {
                    const field = col.getField();
                    if (!priorityColumns.includes(field)) {
                        col.hide();
                    }
                });
                btn.textContent = 'Show All Columns';
                btn.classList.remove('active');
            }
        }

        function downloadFiltered() {
            // Get the filtered data from the table
            const filteredData = table.getData("active");
            
            // Convert to CSV
            const csv = Papa.unparse(filteredData);
            
            // Create filename with filters
            const deptValue = document.getElementById('deptFilter').value;
            const objectValue = document.getElementById('objectFilter').value;
            let filename = 'general-fund-expenditures';
            if (deptValue) filename += '-' + deptValue.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            if (objectValue) filename += '-' + objectValue.substring(0, 30).replace(/[^a-z0-9]/gi, '-').toLowerCase();
            filename += '.csv';
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Load on page load
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
