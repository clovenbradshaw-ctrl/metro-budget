<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Fund Expenditures Dashboard</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #f9fafb;
            color: #1f2937;
        }
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .download-btn {
            padding: 10px 18px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .download-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .tabs {
            display: flex;
            gap: 4px;
            background: rgba(255,255,255,0.1);
            padding: 4px;
            border-radius: 10px;
            margin-top: 12px;
        }
        .tab {
            padding: 10px 20px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }
        .tab.active {
            background: white;
            color: #667eea;
        }
        .content {
            padding: 24px 32px;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .metric-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .metric-label {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }
        .metric-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }
        .chart-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .toolbar {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .date-range-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .date-input {
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            min-width: 150px;
            transition: all 0.2s;
        }
        .date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .filters-section {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }
        .filter-group {
            min-width: 180px;
        }
        .filter-label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .filter-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-select:hover {
            border-color: #667eea;
        }
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .action-btn {
            padding: 10px 18px;
            background: white;
            color: #4b5563;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .action-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f9fafb;
        }
        .action-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .clear-btn {
            padding: 10px 18px;
            background: #fee;
            color: #dc2626;
            border: 2px solid #fecaca;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .clear-btn:hover {
            background: #fecaca;
        }
        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 16px 20px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        .stat-label {
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }
        .ai-legend {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            font-size: 13px;
            color: #1e40af;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }
        .ai-legend:hover {
            background: #dbeafe;
            border-color: #93c5fd;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
        }
        .modal-body {
            padding: 24px 32px;
            line-height: 1.6;
            color: #374151;
        }
        .modal-body h3 {
            color: #1f2937;
            font-size: 16px;
            font-weight: 700;
            margin: 20px 0 10px 0;
        }
        .modal-body ul {
            margin: 10px 0;
            padding-left: 24px;
        }
        .modal-body li {
            margin: 8px 0;
        }
        .modal-footer {
            padding: 16px 32px 24px;
            text-align: right;
        }
        .close-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .close-btn:hover {
            background: #5568d3;
        }
        .tabulator {
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .tabulator .tabulator-header {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }
        .tabulator .tabulator-header .tabulator-col {
            background: transparent;
            border-right: 1px solid #e5e7eb;
        }
        .tabulator .tabulator-header .tabulator-col-title {
            font-size: 12px;
            font-weight: 700;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .tabulator .tabulator-row {
            border-bottom: 1px solid #f3f4f6;
        }
        .tabulator .tabulator-row:hover {
            background: #fafbfc;
        }
        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #6b7280;
        }
        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            padding: 20px;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 10px;
            border: 1px solid #fecaca;
        }
        .footer {
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            padding: 32px;
            margin-top: 48px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            line-height: 1.6;
        }
        .footer-links {
            display: flex;
            gap: 24px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .footer-links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        .footer-links a:hover {
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <img src="https://storage.googleapis.com/intelechia-content/metro-budget-data/change%20log%20logo.png" alt="Change Log Nashville" style="height: 48px; width: auto;">
                    <div>
                        <h1>General Fund Expenditures Dashboard</h1>
                        <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">Making Nashville's public spending actually public</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="download-btn" onclick="App.downloadRawCSV()">â†“ Raw Data</button>
                    <button class="download-btn" onclick="App.downloadData()">â†“ Filtered View</button>
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="App.switchView('dashboard')">Dashboard</button>
                <button class="tab" onclick="App.switchView('transactions')">Transactions</button>
                <button class="tab" onclick="App.switchView('invoices')">By Invoice</button>
                <button class="tab" onclick="App.switchView('vendors')">By Vendor</button>
                <button class="tab" onclick="App.switchView('pivot')">By Department</button>
            </div>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div>Loading expenditure data...</div>
            </div>
            <div id="error" style="display: none;"></div>
            
            <!-- Dashboard View -->
            <div id="dashboardView" class="view active">
                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px 20px; margin-bottom: 24px;">
                    <div style="font-size: 14px; color: #1e40af; line-height: 1.6;">
                        <strong>July - August 2025</strong> â€¢ General Fund transactions provided by Metro Nashville via public records request. Department information decoded from accounting strings using AI-assisted analysis of Metro's FY26 budget structure.
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-label">Date Range</div>
                        <div class="metric-value" id="firstDay">-</div>
                        <div class="metric-subtitle" id="dateRange">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Transactions</div>
                        <div class="metric-value" id="totalTransactions">0</div>
                        <div class="metric-subtitle" id="firstDayCount">Across all departments</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Amount</div>
                        <div class="metric-value" id="dashTotalAmount">$0</div>
                        <div class="metric-subtitle" id="avgTransaction">Avg: $0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Unique Vendors</div>
                        <div class="metric-value" id="uniqueVendors">0</div>
                        <div class="metric-subtitle" id="unconfirmedDepts">0 unconfirmed depts</div>
                    </div>
                </div>
                
                <div class="chart-section">
                    <div class="chart-title">Expenditure Analysis</div>
                    <div class="chart-grid">
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Transactions View -->
            <div id="transactionsView" class="view">
                <div class="toolbar">
                    <div class="search-bar">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search transactions...">
                        <div class="date-range-wrapper">
                            <input type="date" id="dateFrom" class="date-input" placeholder="From date">
                            <span style="color: #9ca3af;">â†’</span>
                            <input type="date" id="dateTo" class="date-input" placeholder="To date">
                        </div>
                    </div>
                    
                    <div class="filters-section">
                        <div class="filter-group">
                            <label class="filter-label">Department</label>
                            <select id="deptFilter" class="filter-select">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Business Unit</label>
                            <select id="buFilter" class="filter-select">
                                <option value="">All Business Units</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Object Code</label>
                            <select id="objCodeFilter" class="filter-select">
                                <option value="">All Object Codes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Rows per page</label>
                            <select id="pageSizeSelect" class="filter-select">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="250">250</option>
                            </select>
                        </div>
                        <button id="toggleColumns" class="action-btn" onclick="App.toggleAllColumns()">
                            Show All Columns
                        </button>
                        <button class="clear-btn" onclick="App.clearFilters()">
                            Clear Filters
                        </button>
                    </div>
                </div>
                
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-label">Total Rows</span>
                        <span class="stat-value" id="totalRows">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Filtered Rows</span>
                        <span class="stat-value" id="filteredRows">0</span>
                    </div>
                    <div class="stat-item" id="filteredAmountStat" style="display: none;">
                        <span class="stat-label">Filtered Amount</span>
                        <span class="stat-value" id="filteredAmount">$0</span>
                    </div>
                    <div class="ai-legend" onclick="App.openModal()">
                        <span>ðŸ¤–</span>
                        <span>AI-Analyzed Fields</span>
                    </div>
                </div>
                
                <div id="transactionsTable"></div>
            </div>
            
            <!-- Invoices View -->
            <div id="invoicesView" class="view">
                <div class="toolbar">
                    <div class="search-bar">
                        <input type="text" id="invoiceSearchInput" class="search-input" placeholder="Search invoices...">
                    </div>
                    <div class="filters-section">
                        <div class="filter-group">
                            <label class="filter-label">Rows per page</label>
                            <select id="invoicePageSize" class="filter-select">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <button class="clear-btn" onclick="App.clearInvoiceSearch()">
                            Clear Search
                        </button>
                    </div>
                </div>
                
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-label">Total Invoices</span>
                        <span class="stat-value" id="totalInvoices">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Invoice Amount</span>
                        <span class="stat-value" id="totalInvoiceAmount">$0</span>
                    </div>
                </div>
                
                <div id="invoicesTable"></div>
            </div>
            
            <!-- Vendors View -->
            <div id="vendorsView" class="view">
                <div class="toolbar">
                    <div class="search-bar">
                        <input type="text" id="vendorSearchInput" class="search-input" placeholder="Search vendors...">
                    </div>
                    <div class="filters-section">
                        <div class="filter-group">
                            <label class="filter-label">Rows per page</label>
                            <select id="vendorPageSize" class="filter-select">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <button class="clear-btn" onclick="App.clearVendorSearch()">
                            Clear Search
                        </button>
                    </div>
                </div>
                
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-label">Total Vendors</span>
                        <span class="stat-value" id="totalVendors">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Vendor Payments</span>
                        <span class="stat-value" id="totalVendorAmount">$0</span>
                    </div>
                </div>
                
                <div id="vendorsTable"></div>
            </div>
            
            <!-- Pivot View -->
            <div id="pivotView" class="view">
                <div class="toolbar">
                    <div class="filters-section">
                        <div class="filter-group" style="flex: 1; max-width: 400px;">
                            <label class="filter-label">Select Department</label>
                            <select id="pivotDeptFilter" class="filter-select">
                                <option value="">Select a department...</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Rows per page</label>
                            <select id="pivotPageSize" class="filter-select">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="stats-bar" id="pivotStatsBar" style="display: none;">
                    <div class="stat-item">
                        <span class="stat-label">Selected Department</span>
                        <span class="stat-value" id="selectedDepartment">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Object Categories</span>
                        <span class="stat-value" id="totalObjectCodes">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Transactions</span>
                        <span class="stat-value" id="pivotTransactionCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Department Spending</span>
                        <span class="stat-value" id="totalPivotAmount">$0</span>
                    </div>
                </div>
                
                <div id="pivotPlaceholder" style="padding: 80px 20px; text-align: center; color: #6b7280;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“Š</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Select a Department</div>
                    <div style="font-size: 14px;">Choose a department from the dropdown above to view spending by object code</div>
                </div>
                
                <div id="pivotTable" style="display: none;"></div>
            </div>
        </div>
        
        <div class="footer">
            <div><strong>Change Log Nashville</strong></div>
            <div style="margin-top: 8px;">
                Making Nashville's public spending data actually public â€¢ Data: July-August 2025
            </div>
            <div class="footer-links">
                <a href="https://storage.googleapis.com/intelechia-content/metro-budget-data/general%20fund/General%20Fund%2010101%20July%20and%20August%202025%20Expenditures%20-%20PRR%2001936525(Data).csv" target="_blank">Original Data Source</a>
                <a href="#" onclick="App.openModal(); return false;">How This Was Made</a>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="aiModal" class="modal" onclick="App.closeModalOnOutsideClick(event)">
        <div class="modal-content">
            <div class="modal-header">
                <span style="font-size: 32px;">ðŸ¤–</span>
                <h2>How This Data Was Made Readable</h2>
            </div>
            <div class="modal-body">
                <h3>The Problem</h3>
                <p>Metro Nashville provided transaction data without department names in readable format. When asked to include this basic information, they responded:</p>
                
                <blockquote style="background: #f9fafb; border-left: 4px solid #667eea; padding: 16px; margin: 16px 0; font-style: italic; color: #4b5563;">
                    "In accordance with the Tennessee Public Records Act, our obligation is to provide access to existing records as they are maintained. The database does not maintain a separate field for the department name because the department number is imbedded in the accounting string. As you noted, the information in question is publicly accessible and can be obtained from existing sources to convert the department number to a name. We are not required to reformat or manipulate records beyond their original form."
                </blockquote>

                <h3>The Solution</h3>
                <p>To make this data usable, AI tools (Claude and ChatGPT) were used to:</p>
                <ul>
                    <li>Extract department codes from cryptic accounting strings (GL Account Strings)</li>
                    <li>Parse Metro's 600+ page FY26 budget to identify ~500 business unit codes</li>
                    <li>Match each transaction to its department and business unit description</li>
                    <li>Link object codes to their descriptions from the budget structure</li>
                </ul>

                <h3>AI-Derived Columns</h3>
                <p>Fields marked with ðŸ¤– were reconstructed through this process:</p>
                <ul>
                    <li><strong>Department</strong> - Extracted from GL Account String business unit codes</li>
                    <li><strong>Business Unit Description</strong> - Matched from budget document analysis</li>
                    <li><strong>Object Code</strong> - Parsed from GL Account String segments</li>
                    <li><strong>Object Description</strong> - Linked from FY26 budget object code definitions</li>
                </ul>

                <h3>Data Quality</h3>
                <p>While this automated process is substantially accurate for analysis purposes, a small percentage of transactions could not be definitively matched to departments and are marked as "Unconfirmed." For critical decisions or detailed research, always verify with original Metro Finance records.</p>
                
                <p style="margin-top: 16px;"><strong>The original raw data is available via the "Raw Data" download button.</strong></p>
                
                <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 13px; color: #6b7280;">
                    <strong>Notice an error?</strong> Email <a href="mailto:michaeltlacy@gmail.com" style="color: #667eea;">michaeltlacy@gmail.com</a>
                </p>
            </div>
            <div class="modal-footer">
                <button class="close-btn" onclick="App.closeModal()">Got it</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            CSV_URL: 'https://storage.googleapis.com/intelechia-content/metro-budget-data/general%20fund/General%20Fund%2010101%20July%20and%20August%202025%20Expenditures%20-%20PRR%2001936525(Data).csv',
            METRO_STRUCTURE_URL: 'https://raw.githubusercontent.com/clovenbradshaw-ctrl/metro-budget/refs/heads/main/metro-data-structure.json',
            PRIORITY_COLUMNS: [
                'Total', 'Department', 'Business Unit Code', 'Business Unit Description',
                'Object Code', 'Object Description', 'Explanation', 'GL Date',
                'Address Book Name', 'Invoice Number', 'Invoice Date', 'Payment Date', 'PO #'
            ],
            AI_COLUMNS: ['Department', 'Business Unit Description', 'Object Code', 'Object Description']
        };

        const App = {
            state: {
                rawData: [],
                processedData: [],
                metroStructure: null,
                businessUnitLookup: {},
                objectCodeLookup: {},
                currentView: 'dashboard',
                showingAllColumns: false,
                tables: {
                    transactions: null,
                    invoices: null,
                    vendors: null,
                    pivot: null
                },
                charts: {
                    department: null,
                    daily: null
                }
            },

            async init() {
                try {
                    await this.loadMetroStructure();
                    await this.loadCSVData();
                    this.processData();
                    this.initializeDashboard();
                    this.initializeViews();
                    this.setupEventListeners();
                    document.getElementById('loading').style.display = 'none';
                } catch (error) {
                    this.showError(error);
                }
            },

            async loadMetroStructure() {
                console.log('Loading metro structure...');
                const response = await fetch(CONFIG.METRO_STRUCTURE_URL);
                if (!response.ok) throw new Error(`Failed to fetch structure: ${response.status}`);
                
                this.state.metroStructure = await response.json();
                this.buildLookupTables();
            },

            async loadCSVData() {
                console.log('Loading CSV data...');
                const response = await fetch(CONFIG.CSV_URL);
                if (!response.ok) throw new Error(`Failed to fetch CSV: ${response.status}`);
                
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });
                
                this.state.rawData = parsed.data;
            },

            buildLookupTables() {
                this.state.metroStructure.departments.forEach(dept => {
                    dept.business_units.forEach(bu => {
                        this.state.businessUnitLookup[bu.code] = {
                            description: bu.description,
                            department: dept.name,
                            departmentCode: dept.code
                        };
                    });
                });
                
                if (this.state.metroStructure.other_entities?.authorities_and_boards) {
                    this.state.metroStructure.other_entities.authorities_and_boards.forEach(entity => {
                        entity.business_units.forEach(bu => {
                            this.state.businessUnitLookup[bu.code] = {
                                description: bu.description,
                                department: entity.name || 'Other Entities',
                                departmentCode: entity.code || 'N/A'
                            };
                        });
                    });
                }

                if (this.state.metroStructure.object_codes) {
                    this.state.metroStructure.object_codes.forEach(obj => {
                        this.state.objectCodeLookup[obj.code] = obj.description;
                    });
                }
            },

            processData() {
                this.state.processedData = this.state.rawData.map(row => {
                    const buInfo = this.getBusinessUnitInfo(row);
                    const objInfo = this.getObjectCodeInfo(row);
                    
                    return {
                        'Department': buInfo.department,
                        'Business Unit Code': buInfo.businessUnitCode,
                        'Business Unit Description': buInfo.description,
                        'Object Code': objInfo.code,
                        'Object Description': objInfo.description,
                        ...row
                    };
                });
            },

            getBusinessUnitInfo(row) {
                const glString = row['Gl Account String'] || row['Account Number'];
                let businessUnitCode = null;
                
                if (glString) {
                    const segments = String(glString).split('.');
                    if (segments.length > 0) {
                        businessUnitCode = String(parseInt(segments[0], 10));
                    }
                }
                
                if (businessUnitCode && this.state.businessUnitLookup[businessUnitCode]) {
                    return {
                        ...this.state.businessUnitLookup[businessUnitCode],
                        businessUnitCode: businessUnitCode
                    };
                }
                
                return {
                    description: 'Unknown Business Unit',
                    department: 'Unconfirmed',
                    departmentCode: 'N/A',
                    businessUnitCode: businessUnitCode || 'N/A'
                };
            },

            getObjectCodeInfo(row) {
                const glString = row['Gl Account String'] || row['Account Number'];
                let objectCode = null;
                
                if (glString) {
                    const segments = String(glString).split('.');
                    if (segments.length > 1) {
                        objectCode = segments[1];
                    }
                }
                
                if (objectCode && this.state.objectCodeLookup[objectCode]) {
                    return {
                        code: objectCode,
                        description: this.state.objectCodeLookup[objectCode]
                    };
                }
                
                return {
                    code: objectCode || 'N/A',
                    description: 'Unknown Object Code'
                };
            },

            initializeDashboard() {
                const dates = this.state.processedData
                    .map(row => row['GL Date'] || row['Invoice Date'] || row['Payment Date'])
                    .filter(d => d)
                    .map(d => new Date(d))
                    .sort((a, b) => a - b);
                
                if (dates.length === 0) return;
                
                const firstDate = dates[0];
                const lastDate = dates[dates.length - 1];
                
                const uniqueVendors = new Set(
                    this.state.processedData
                        .map(row => row['Address Book Name'])
                        .filter(name => name && name.trim())
                ).size;
                
                const unconfirmedCount = this.state.processedData.filter(row => 
                    row['Department'] === 'Unconfirmed' || !row['Department']
                ).length;
                
                const totalAmount = this.state.processedData.reduce((sum, row) => 
                    sum + (parseFloat(row['Total']) || 0), 0);
                const avgTransaction = totalAmount / this.state.processedData.length;
                
                document.getElementById('firstDay').textContent = firstDate.toLocaleDateString();
                document.getElementById('dateRange').textContent = 
                    `to ${lastDate.toLocaleDateString()}`;
                document.getElementById('totalTransactions').textContent = this.state.processedData.length.toLocaleString();
                document.getElementById('dashTotalAmount').textContent = 
                    '$' + totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('avgTransaction').textContent = 
                    'Avg: $' + avgTransaction.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('uniqueVendors').textContent = uniqueVendors.toLocaleString();
                document.getElementById('unconfirmedDepts').textContent = 
                    `${unconfirmedCount.toLocaleString()} unconfirmed depts`;
                
                this.createCharts();
            },

            createCharts() {
                const deptSpending = {};
                this.state.processedData.forEach(row => {
                    const dept = row['Department'] || 'Unknown';
                    const amount = parseFloat(row['Total']) || 0;
                    deptSpending[dept] = (deptSpending[dept] || 0) + amount;
                });
                
                const deptLabels = Object.keys(deptSpending)
                    .sort((a, b) => deptSpending[b] - deptSpending[a])
                    .slice(0, 10);
                const deptData = deptLabels.map(label => deptSpending[label]);
                
                const deptCtx = document.getElementById('departmentChart').getContext('2d');
                this.state.charts.department = new Chart(deptCtx, {
                    type: 'bar',
                    data: {
                        labels: deptLabels,
                        datasets: [{
                            label: 'Spending by Department',
                            data: deptData,
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Top 10 Departments by Spending' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: value => '$' + value.toLocaleString() }
                            },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                });
                
                const dailyData = {};
                this.state.processedData.forEach(row => {
                    const date = row['GL Date'] || row['Invoice Date'] || row['Payment Date'];
                    if (date) {
                        const dateStr = new Date(date).toLocaleDateString();
                        dailyData[dateStr] = (dailyData[dateStr] || 0) + 1;
                    }
                });
                
                const dailyLabels = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
                const dailyCounts = dailyLabels.map(label => dailyData[label]);
                
                const dailyCtx = document.getElementById('dailyChart').getContext('2d');
                this.state.charts.daily = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: 'Daily Transactions',
                            data: dailyCounts,
                            backgroundColor: 'rgba(118, 75, 162, 0.2)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Transactions Over Time' }
                        },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            },

            initializeViews() {
                this.initializeTransactionsView();
                this.initializeInvoicesView();
                this.initializeVendorsView();
                this.initializePivotView();
            },

            initializeTransactionsView() {
                this.populateFilters();
                
                const columns = this.buildTransactionColumns();
                
                this.state.tables.transactions = new Tabulator("#transactionsTable", {
                    data: this.state.processedData,
                    columns: columns,
                    layout: "fitDataStretch",
                    pagination: true,
                    paginationSize: 50,
                    movableColumns: true,
                    resizableColumns: true,
                    initialSort: [{column: "GL Date", dir: "desc"}]
                });

                this.state.tables.transactions.on("dataFiltered", () => this.updateTransactionStats());
                this.state.tables.transactions.on("dataLoaded", () => this.updateTransactionStats());
                
                this.updateTransactionStats();
            },

            buildTransactionColumns() {
                const allColumnNames = Object.keys(this.state.processedData[0]);
                const columns = [];
                
                CONFIG.PRIORITY_COLUMNS.forEach(colName => {
                    if (allColumnNames.includes(colName)) {
                        columns.push(this.createColumnConfig(colName, true));
                    }
                });
                
                allColumnNames.forEach(colName => {
                    if (!CONFIG.PRIORITY_COLUMNS.includes(colName)) {
                        columns.push(this.createColumnConfig(colName, false));
                    }
                });
                
                return columns;
            },

            createColumnConfig(colName, visible) {
                const config = {
                    title: colName,
                    field: colName,
                    visible: visible,
                    headerSort: true
                };
                
                if (CONFIG.AI_COLUMNS.includes(colName)) {
                    config.titleFormatter = cell => `${cell.getValue()} ðŸ¤–`;
                }
                
                if (colName === 'Total' || colName.includes('Amount')) {
                    config.formatter = cell => {
                        const value = cell.getValue();
                        if (value && !isNaN(value)) {
                            return '$' + parseFloat(value).toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                        return value;
                    };
                }
                
                return config;
            },

            initializeInvoicesView() {
                const invoiceData = this.aggregateByInvoice();
                
                this.state.tables.invoices = new Tabulator("#invoicesTable", {
                    data: invoiceData,
                    columns: [
                        {title: "Invoice Number", field: "invoiceNumber", headerSort: true, width: 150},
                        {title: "Vendor", field: "vendor", headerSort: true},
                        {title: "Department", field: "department", headerSort: true},
                        {title: "Transaction Count", field: "count", headerSort: true, width: 150},
                        {
                            title: "Total Amount",
                            field: "totalAmount",
                            headerSort: true,
                            width: 150,
                            formatter: cell => '$' + parseFloat(cell.getValue()).toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })
                        },
                        {title: "Invoice Date", field: "invoiceDate", headerSort: true, width: 130},
                        {title: "Payment Date", field: "paymentDate", headerSort: true, width: 130}
                    ],
                    layout: "fitDataStretch",
                    pagination: true,
                    paginationSize: 50,
                    initialSort: [{column: "totalAmount", dir: "desc"}]
                });
                
                this.updateInvoiceStats(invoiceData);
            },

            aggregateByInvoice() {
                const invoiceMap = {};
                
                this.state.processedData.forEach(row => {
                    const invoiceNumber = row['Invoice Number'] || 'No Invoice';
                    
                    if (!invoiceMap[invoiceNumber]) {
                        invoiceMap[invoiceNumber] = {
                            invoiceNumber: invoiceNumber,
                            vendor: row['Address Book Name'] || 'Unknown',
                            department: row['Department'] || 'Unknown',
                            invoiceDate: row['Invoice Date'] || '',
                            paymentDate: row['Payment Date'] || '',
                            count: 0,
                            totalAmount: 0
                        };
                    }
                    
                    invoiceMap[invoiceNumber].count++;
                    invoiceMap[invoiceNumber].totalAmount += parseFloat(row['Total']) || 0;
                });
                
                return Object.values(invoiceMap);
            },

            initializeVendorsView() {
                const vendorData = this.aggregateByVendor();
                
                this.state.tables.vendors = new Tabulator("#vendorsTable", {
                    data: vendorData,
                    columns: [
                        {title: "Vendor Name", field: "vendorName", headerSort: true},
                        {title: "Department", field: "department", headerSort: true},
                        {title: "Transaction Count", field: "count", headerSort: true, width: 150},
                        {title: "Invoice Count", field: "invoiceCount", headerSort: true, width: 150},
                        {
                            title: "Total Amount",
                            field: "totalAmount",
                            headerSort: true,
                            width: 150,
                            formatter: cell => '$' + parseFloat(cell.getValue()).toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })
                        },
                        {title: "First Payment", field: "firstPayment", headerSort: true, width: 130},
                        {title: "Last Payment", field: "lastPayment", headerSort: true, width: 130}
                    ],
                    layout: "fitDataStretch",
                    pagination: true,
                    paginationSize: 50,
                    initialSort: [{column: "totalAmount", dir: "desc"}]
                });
                
                this.updateVendorStats(vendorData);
            },

            aggregateByVendor() {
                const vendorMap = {};
                
                this.state.processedData.forEach(row => {
                    const vendorName = row['Address Book Name'] || 'Unknown Vendor';
                    
                    if (!vendorMap[vendorName]) {
                        vendorMap[vendorName] = {
                            vendorName: vendorName,
                            department: row['Department'] || 'Unknown',
                            count: 0,
                            invoiceCount: 0,
                            totalAmount: 0,
                            invoices: new Set(),
                            payments: []
                        };
                    }
                    
                    vendorMap[vendorName].count++;
                    vendorMap[vendorName].totalAmount += parseFloat(row['Total']) || 0;
                    
                    if (row['Invoice Number']) {
                        vendorMap[vendorName].invoices.add(row['Invoice Number']);
                    }
                    
                    const paymentDate = row['Payment Date'] || row['GL Date'];
                    if (paymentDate) {
                        vendorMap[vendorName].payments.push(new Date(paymentDate));
                    }
                });
                
                return Object.values(vendorMap).map(vendor => {
                    vendor.invoiceCount = vendor.invoices.size;
                    vendor.payments.sort((a, b) => a - b);
                    vendor.firstPayment = vendor.payments[0]?.toLocaleDateString() || '';
                    vendor.lastPayment = vendor.payments[vendor.payments.length - 1]?.toLocaleDateString() || '';
                    delete vendor.invoices;
                    delete vendor.payments;
                    return vendor;
                });
            },

            initializePivotView() {
                const departments = [...new Set(this.state.processedData.map(row => row['Department']))]
                    .filter(x => x)
                    .sort();
                
                const pivotDeptFilter = document.getElementById('pivotDeptFilter');
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    pivotDeptFilter.appendChild(option);
                });
            },

            buildPivotTableForDepartment(department) {
                if (!department) {
                    document.getElementById('pivotPlaceholder').style.display = 'block';
                    document.getElementById('pivotTable').style.display = 'none';
                    document.getElementById('pivotStatsBar').style.display = 'none';
                    return;
                }

                const deptData = this.state.processedData.filter(row => 
                    row['Department'] === department
                );

                const objectMap = {};
                deptData.forEach(row => {
                    const objectCode = row['Object Code'] || 'N/A';
                    const objectDescription = row['Object Description'] || 'Unknown';
                    
                    if (!objectMap[objectCode]) {
                        objectMap[objectCode] = {
                            objectCode: objectCode,
                            objectDescription: objectDescription,
                            transactionCount: 0,
                            totalAmount: 0
                        };
                    }
                    
                    objectMap[objectCode].transactionCount++;
                    objectMap[objectCode].totalAmount += parseFloat(row['Total']) || 0;
                });

                const pivotData = Object.values(objectMap);

                if (this.state.tables.pivot) {
                    this.state.tables.pivot.destroy();
                }

                this.state.tables.pivot = new Tabulator("#pivotTable", {
                    data: pivotData,
                    columns: [
                        {
                            title: "Object Code", 
                            field: "objectCode", 
                            headerSort: true, 
                            width: 120,
                            frozen: true
                        },
                        {
                            title: "Object Description", 
                            field: "objectDescription", 
                            headerSort: true
                        },
                        {
                            title: "Transaction Count", 
                            field: "transactionCount", 
                            headerSort: true, 
                            width: 150
                        },
                        {
                            title: "Total Amount",
                            field: "totalAmount",
                            headerSort: true,
                            width: 150,
                            formatter: cell => '$' + parseFloat(cell.getValue()).toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })
                        }
                    ],
                    layout: "fitDataStretch",
                    pagination: true,
                    paginationSize: 50,
                    initialSort: [{column: "totalAmount", dir: "desc"}]
                });

                const totalAmount = pivotData.reduce((sum, row) => sum + row.totalAmount, 0);
                const totalTransactions = pivotData.reduce((sum, row) => sum + row.transactionCount, 0);

                document.getElementById('selectedDepartment').textContent = department;
                document.getElementById('totalObjectCodes').textContent = pivotData.length.toLocaleString();
                document.getElementById('pivotTransactionCount').textContent = totalTransactions.toLocaleString();
                document.getElementById('totalPivotAmount').textContent = 
                    '$' + totalAmount.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });

                document.getElementById('pivotPlaceholder').style.display = 'none';
                document.getElementById('pivotTable').style.display = 'block';
                document.getElementById('pivotStatsBar').style.display = 'flex';
            },

            setupEventListeners() {
                document.getElementById('searchInput').addEventListener('input', () => this.applyTransactionFilters());
                document.getElementById('deptFilter').addEventListener('change', () => this.applyTransactionFilters());
                document.getElementById('buFilter').addEventListener('change', () => this.applyTransactionFilters());
                document.getElementById('objCodeFilter').addEventListener('change', () => this.applyTransactionFilters());
                document.getElementById('dateFrom').addEventListener('change', () => this.applyTransactionFilters());
                document.getElementById('dateTo').addEventListener('change', () => this.applyTransactionFilters());
                document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
                    this.state.tables.transactions.setPageSize(parseInt(e.target.value));
                });
                
                document.getElementById('invoiceSearchInput').addEventListener('input', () => this.applyInvoiceFilter());
                document.getElementById('invoicePageSize').addEventListener('change', (e) => {
                    this.state.tables.invoices.setPageSize(parseInt(e.target.value));
                });
                
                document.getElementById('vendorSearchInput').addEventListener('input', () => this.applyVendorFilter());
                document.getElementById('vendorPageSize').addEventListener('change', (e) => {
                    this.state.tables.vendors.setPageSize(parseInt(e.target.value));
                });
                
                document.getElementById('pivotDeptFilter').addEventListener('change', (e) => {
                    this.buildPivotTableForDepartment(e.target.value);
                });
                document.getElementById('pivotPageSize').addEventListener('change', (e) => {
                    if (this.state.tables.pivot) {
                        this.state.tables.pivot.setPageSize(parseInt(e.target.value));
                    }
                });
            },

            applyTransactionFilters() {
                const filters = [];
                let hasActiveFilters = false;
                
                const searchValue = document.getElementById('searchInput').value.trim();
                if (searchValue) {
                    hasActiveFilters = true;
                    filters.push(data => {
                        const searchLower = searchValue.toLowerCase();
                        return Object.values(data).some(value => {
                            if (value === null || value === undefined) return false;
                            return String(value).toLowerCase().includes(searchLower);
                        });
                    });
                }
                
                const deptValue = document.getElementById('deptFilter').value;
                if (deptValue) {
                    filters.push(data => data['Department'] === deptValue);
                    hasActiveFilters = true;
                }
                
                const buValue = document.getElementById('buFilter').value;
                if (buValue) {
                    filters.push(data => data['Business Unit Description'] === buValue);
                    hasActiveFilters = true;
                }
                
                const objCodeValue = document.getElementById('objCodeFilter').value;
                if (objCodeValue) {
                    filters.push(data => data['Object Code'] === objCodeValue);
                    hasActiveFilters = true;
                }
                
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                if (dateFrom || dateTo) {
                    hasActiveFilters = true;
                    filters.push(data => {
                        const dateFields = ['GL Date', 'Invoice Date', 'Payment Date'];
                        
                        for (let field of dateFields) {
                            if (data[field]) {
                                const rowDate = new Date(data[field]);
                                
                                if (dateFrom) {
                                    const fromDate = new Date(dateFrom);
                                    if (rowDate < fromDate) continue;
                                }
                                
                                if (dateTo) {
                                    const toDate = new Date(dateTo);
                                    toDate.setHours(23, 59, 59, 999);
                                    if (rowDate > toDate) continue;
                                }
                                
                                return true;
                            }
                        }
                        
                        return false;
                    });
                }
                
                if (filters.length > 0) {
                    this.state.tables.transactions.setFilter(data => {
                        return filters.every(filterFn => filterFn(data));
                    });
                } else {
                    this.state.tables.transactions.clearFilter();
                }
                
                const filteredAmountStat = document.getElementById('filteredAmountStat');
                if (filteredAmountStat) {
                    filteredAmountStat.style.display = hasActiveFilters ? 'flex' : 'none';
                }
            },

            applyInvoiceFilter() {
                const searchValue = document.getElementById('invoiceSearchInput').value.trim();
                
                if (searchValue) {
                    this.state.tables.invoices.setFilter(data => {
                        const searchLower = searchValue.toLowerCase();
                        return Object.values(data).some(value => {
                            if (value === null || value === undefined) return false;
                            return String(value).toLowerCase().includes(searchLower);
                        });
                    });
                } else {
                    this.state.tables.invoices.clearFilter();
                }
            },

            applyVendorFilter() {
                const searchValue = document.getElementById('vendorSearchInput').value.trim();
                
                if (searchValue) {
                    this.state.tables.vendors.setFilter(data => {
                        const searchLower = searchValue.toLowerCase();
                        return Object.values(data).some(value => {
                            if (value === null || value === undefined) return false;
                            return String(value).toLowerCase().includes(searchLower);
                        });
                    });
                } else {
                    this.state.tables.vendors.clearFilter();
                }
            },

            updateTransactionStats() {
                const totalRows = this.state.processedData.length;
                
                let filteredData = [];
                if (this.state.tables.transactions.getFilters().length > 0) {
                    filteredData = this.state.tables.transactions.searchData(
                        this.state.tables.transactions.getFilters()
                    );
                } else {
                    filteredData = this.state.processedData;
                }
                
                const filteredRows = filteredData.length;
                const totalAmount = filteredData.reduce((sum, row) => 
                    sum + (parseFloat(row['Total']) || 0), 0);
                
                document.getElementById('totalRows').textContent = totalRows.toLocaleString();
                document.getElementById('filteredRows').textContent = filteredRows.toLocaleString();
                document.getElementById('filteredAmount').textContent = 
                    '$' + totalAmount.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
            },

            updateInvoiceStats(invoiceData) {
                const totalInvoices = invoiceData.length;
                const totalAmount = invoiceData.reduce((sum, inv) => sum + inv.totalAmount, 0);
                
                document.getElementById('totalInvoices').textContent = totalInvoices.toLocaleString();
                document.getElementById('totalInvoiceAmount').textContent = 
                    '$' + totalAmount.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
            },

            updateVendorStats(vendorData) {
                const totalVendors = vendorData.length;
                const totalAmount = vendorData.reduce((sum, vendor) => sum + vendor.totalAmount, 0);
                
                document.getElementById('totalVendors').textContent = totalVendors.toLocaleString();
                document.getElementById('totalVendorAmount').textContent = 
                    '$' + totalAmount.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
            },

            switchView(viewName) {
                this.state.currentView = viewName;
                
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                document.getElementById(viewName + 'View').classList.add('active');
            },

            populateFilters() {
                const departments = [...new Set(this.state.processedData.map(row => row['Department']))]
                    .filter(x => x).sort();
                const deptFilter = document.getElementById('deptFilter');
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    deptFilter.appendChild(option);
                });

                const businessUnits = [...new Set(this.state.processedData.map(row => 
                    row['Business Unit Description']).filter(x => x))].sort();
                const buFilter = document.getElementById('buFilter');
                businessUnits.forEach(bu => {
                    const option = document.createElement('option');
                    option.value = bu;
                    option.textContent = bu;
                    buFilter.appendChild(option);
                });

                const objectCodes = [...new Set(this.state.processedData.map(row => 
                    row['Object Code']).filter(x => x && x !== 'N/A'))].sort();
                const objCodeFilter = document.getElementById('objCodeFilter');
                objectCodes.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = code;
                    objCodeFilter.appendChild(option);
                });
            },

            clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('deptFilter').value = '';
                document.getElementById('buFilter').value = '';
                document.getElementById('objCodeFilter').value = '';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                
                this.state.tables.transactions.clearFilter();
                document.getElementById('filteredAmountStat').style.display = 'none';
                this.updateTransactionStats();
            },

            clearInvoiceSearch() {
                document.getElementById('invoiceSearchInput').value = '';
                this.state.tables.invoices.clearFilter();
            },

            clearVendorSearch() {
                document.getElementById('vendorSearchInput').value = '';
                this.state.tables.vendors.clearFilter();
            },

            toggleAllColumns() {
                this.state.showingAllColumns = !this.state.showingAllColumns;
                const btn = document.getElementById('toggleColumns');
                
                if (this.state.showingAllColumns) {
                    this.state.tables.transactions.getColumns().forEach(col => col.show());
                    btn.textContent = 'Show Essential Columns';
                    btn.classList.add('active');
                } else {
                    this.state.tables.transactions.getColumns().forEach(col => {
                        const field = col.getField();
                        if (!CONFIG.PRIORITY_COLUMNS.includes(field)) {
                            col.hide();
                        }
                    });
                    btn.textContent = 'Show All Columns';
                    btn.classList.remove('active');
                }
            },

            downloadData() {
                let dataToExport = [];
                let filename = 'metro-expenditures';
                
                if (this.state.currentView === 'transactions') {
                    dataToExport = this.state.tables.transactions.getData("active");
                    filename = 'transactions-filtered';
                } else if (this.state.currentView === 'invoices') {
                    dataToExport = this.state.tables.invoices.getData("active");
                    filename = 'invoices-filtered';
                } else if (this.state.currentView === 'vendors') {
                    dataToExport = this.state.tables.vendors.getData("active");
                    filename = 'vendors-filtered';
                } else if (this.state.currentView === 'pivot') {
                    if (this.state.tables.pivot) {
                        const selectedDept = document.getElementById('pivotDeptFilter').value;
                        dataToExport = this.state.tables.pivot.getData("active");
                        filename = `dept-${selectedDept.replace(/\s+/g, '-').toLowerCase()}-by-object`;
                    } else {
                        alert('Please select a department first.');
                        return;
                    }
                } else {
                    dataToExport = this.state.processedData;
                    filename = 'all-transactions-filtered';
                }
                
                if (dataToExport.length === 0) {
                    alert('No data to download.');
                    return;
                }
                
                const csv = Papa.unparse(dataToExport);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `changelog-nash-${filename}-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            },

            downloadRawCSV() {
                if (this.state.rawData.length === 0) {
                    alert('No raw data available.');
                    return;
                }
                
                const csv = Papa.unparse(this.state.rawData);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `changelog-nash-raw-data-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            },

            openModal() {
                document.getElementById('aiModal').style.display = 'block';
            },

            closeModal() {
                document.getElementById('aiModal').style.display = 'none';
            },

            closeModalOnOutsideClick(event) {
                if (event.target === document.getElementById('aiModal')) {
                    this.closeModal();
                }
            },

            showError(error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.style.display = 'block';
                errorDiv.className = 'error';
                errorDiv.innerHTML = `Error: ${error.message}<br><br>Check console for details.`;
            }
        };

        window.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
