<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Fund Expenditures Dashboard</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #f9fafb;
            color: #1f2937;
        }
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .download-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .download-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .content {
            padding: 24px 32px;
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: none;
            margin-bottom: 24px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .metric-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .metric-label {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }
        .metric-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }
        .chart-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Toolbar Styles */
        .toolbar {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: none;
        }
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .search-input::placeholder {
            color: #9ca3af;
        }
        .date-range-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .date-input {
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            min-width: 150px;
            transition: all 0.2s;
        }
        .date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .filters-section {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }
        .filter-group {
            min-width: 180px;
        }
        .filter-label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .filter-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-select:hover {
            border-color: #667eea;
        }
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .action-btn {
            padding: 10px 18px;
            background: white;
            color: #4b5563;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .action-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f9fafb;
        }
        .action-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .clear-btn {
            padding: 10px 18px;
            background: #fee;
            color: #dc2626;
            border: 2px solid #fecaca;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .clear-btn:hover {
            background: #fecaca;
        }
        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 16px 20px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            display: none;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        .stat-label {
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }
        .ai-legend {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            font-size: 13px;
            color: #1e40af;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }
        .ai-legend:hover {
            background: #dbeafe;
            border-color: #93c5fd;
        }
        .ai-legend-icon {
            font-size: 16px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
        }
        .modal-body {
            padding: 24px 32px;
            line-height: 1.6;
            color: #374151;
        }
        .modal-body h3 {
            color: #1f2937;
            font-size: 16px;
            font-weight: 700;
            margin: 20px 0 10px 0;
        }
        .modal-body h3:first-child {
            margin-top: 0;
        }
        .modal-body ul {
            margin: 10px 0;
            padding-left: 24px;
        }
        .modal-body li {
            margin: 8px 0;
        }
        .modal-body strong {
            color: #1f2937;
        }
        .modal-footer {
            padding: 16px 32px 24px;
            text-align: right;
        }
        .close-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .close-btn:hover {
            background: #5568d3;
        }
        
        /* Table Styles */
        .tabulator {
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .tabulator .tabulator-header {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }
        .tabulator .tabulator-header .tabulator-col {
            background: transparent;
            border-right: 1px solid #e5e7eb;
        }
        .tabulator .tabulator-header .tabulator-col .tabulator-col-content {
            padding: 12px 10px;
        }
        .tabulator .tabulator-header .tabulator-col .tabulator-col-title {
            font-size: 12px;
            font-weight: 700;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .tabulator .tabulator-row {
            border-bottom: 1px solid #f3f4f6;
        }
        .tabulator .tabulator-row:hover {
            background: #fafbfc;
        }
        .tabulator .tabulator-row .tabulator-cell {
            border-right: 1px solid #f3f4f6;
            padding: 12px 10px;
        }
        
        /* Loading Styles */
        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #6b7280;
        }
        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            padding: 20px;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 10px;
            border: 1px solid #fecaca;
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .search-input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>ðŸ“Š General Fund Expenditures Dashboard</h1>
                <button class="download-btn" onclick="downloadFiltered()">â†“ Download CSV</button>
            </div>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div>Loading expenditure data...</div>
            </div>
            <div id="error" style="display: none;"></div>
            
            <!-- Dashboard Section -->
            <div id="dashboard" class="dashboard">
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-label">First Day</div>
                        <div class="metric-value" id="firstDay">-</div>
                        <div class="metric-subtitle" id="firstDayCount">- transactions</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Last Day</div>
                        <div class="metric-value" id="lastDay">-</div>
                        <div class="metric-subtitle" id="lastDayCount">- transactions</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Transactions</div>
                        <div class="metric-value" id="totalTransactions">0</div>
                        <div class="metric-subtitle" id="dateRange">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Amount</div>
                        <div class="metric-value" id="dashTotalAmount">$0</div>
                        <div class="metric-subtitle" id="avgTransaction">Avg: $0</div>
                    </div>
                </div>
                
                <div class="chart-section">
                    <div class="chart-title">Expenditure Analysis</div>
                    <div class="chart-grid">
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Toolbar Section -->
            <div id="toolbar" class="toolbar">
                <div class="search-bar">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input" 
                        placeholder="ðŸ” Search transactions..."
                    >
                    <div class="date-range-wrapper">
                        <input 
                            type="date" 
                            id="dateFrom" 
                            class="date-input" 
                            placeholder="From date"
                        >
                        <span style="color: #9ca3af;">â†’</span>
                        <input 
                            type="date" 
                            id="dateTo" 
                            class="date-input" 
                            placeholder="To date"
                        >
                    </div>
                </div>
                
                <div class="filters-section">
                    <div class="filter-group">
                        <label class="filter-label">Department</label>
                        <select id="deptFilter" class="filter-select">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Business Unit Description</label>
                        <select id="buFilter" class="filter-select">
                            <option value="">All Business Units</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Object Code</label>
                        <select id="objCodeFilter" class="filter-select">
                            <option value="">All Object Codes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Object Description</label>
                        <select id="objDescFilter" class="filter-select">
                            <option value="">All Descriptions</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Rows per page</label>
                        <select id="pageSizeSelect" class="filter-select">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                    <button id="toggleColumns" class="action-btn" onclick="toggleAllColumns()">
                        Show All Columns
                    </button>
                    <button class="clear-btn" onclick="clearAllFilters()">
                        Clear Filters
                    </button>
                </div>
            </div>
            
            <!-- Stats Bar -->
            <div id="stats" class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Total Rows</span>
                    <span class="stat-value" id="totalRows">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Filtered Rows</span>
                    <span class="stat-value" id="filteredRows">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Amount</span>
                    <span class="stat-value" id="totalAmount">$0</span>
                </div>
                <div class="ai-legend" onclick="openModal()">
                    <span class="ai-legend-icon">ðŸ¤–</span>
                    <span>AI-Analyzed Fields</span>
                </div>
            </div>
            
            <!-- Table -->
            <div id="table"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="aiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span style="font-size: 32px;">ðŸ¤–</span>
                <h2>AI-Analyzed Fields</h2>
            </div>
            <div class="modal-body">
                <p>Columns marked with ðŸ¤– in the table are <strong>derived from GL Account Strings</strong> using AI-assisted mapping and parsing.</p>
                
                <h3>AI-Derived Columns:</h3>
                <ul>
                    <li><strong>Department</strong> - Mapped from Business Unit codes in GL strings</li>
                    <li><strong>Business Unit Description</strong> - Parsed and matched from GL Account String</li>
                    <li><strong>Object Code</strong> - Extracted from GL Account String segments</li>
                    <li><strong>Object Description</strong> - Matched from FY26 budget structure</li>
                </ul>

                <h3>Data Source:</h3>
                <p>These mappings are based on Metro's FY26 budget documents and organizational structure. The AI analyzes the GL Account String format (e.g., "10101.5010.123") and matches codes to their corresponding descriptions.</p>

                <h3>Accuracy Note:</h3>
                <p>While substantially accurate for analysis and filtering, <strong>always verify with original expenditure files</strong> for authoritative information and critical decisions.</p>
            </div>
            <div class="modal-footer">
                <button class="close-btn" onclick="closeModal()">Got it</button>
            </div>
        </div>
    </div>

    <script>
        // ======================
        // Configuration
        // ======================
        const CONFIG = {
            CSV_URL: 'https://storage.googleapis.com/intelechia-content/metro-budget-data/general%20fund/General%20Fund%2010101%20July%20and%20August%202025%20Expenditures%20-%20PRR%2001936525(Data).csv',
            METRO_STRUCTURE_URL: 'https://raw.githubusercontent.com/clovenbradshaw-ctrl/metro-budget/refs/heads/main/metro-data-structure.json',
            PRIORITY_COLUMNS: [
                'Total',
                'Department',
                'Business Unit Code',
                'Business Unit Description',
                'Object Code',
                'Object Description',
                'Explanation',
                'GL Date',
                'Address Book Name',
                'Invoice Number',
                'Invoice Date',
                'Payment Date',
                'PO #'
            ],
            AI_COLUMNS: ['Department', 'Business Unit Description', 'Object Code', 'Object Description']
        };

        // ======================
        // State Management
        // ======================
        const state = {
            tableData: [],
            table: null,
            showingAllColumns: false,
            metroStructure: null,
            businessUnitLookup: {},
            objectCodeLookup: {},
            charts: {
                department: null,
                daily: null
            }
        };

        // ======================
        // Data Loading & Processing
        // ======================
        function buildBusinessUnitLookup() {
            state.businessUnitLookup = {};
            
            state.metroStructure.departments.forEach(dept => {
                dept.business_units.forEach(bu => {
                    state.businessUnitLookup[bu.code] = {
                        description: bu.description,
                        department: dept.name,
                        departmentCode: dept.code
                    };
                });
            });
            
            if (state.metroStructure.other_entities?.authorities_and_boards) {
                state.metroStructure.other_entities.authorities_and_boards.forEach(entity => {
                    entity.business_units.forEach(bu => {
                        state.businessUnitLookup[bu.code] = {
                            description: bu.description,
                            department: entity.name || 'Other Entities',
                            departmentCode: entity.code || 'N/A'
                        };
                    });
                });
            }
        }

        function buildObjectCodeLookup() {
            state.objectCodeLookup = {};
            
            if (state.metroStructure.object_codes) {
                state.metroStructure.object_codes.forEach(obj => {
                    state.objectCodeLookup[obj.code] = obj.description;
                });
            }
        }

        function getObjectCodeInfo(row) {
            let objectCode = null;
            
            const glString = row['Gl Account String'] || row['Account Number'];
            if (glString) {
                const segments = String(glString).split('.');
                if (segments.length > 1) {
                    objectCode = segments[1];
                }
            }
            
            if (objectCode && state.objectCodeLookup[objectCode]) {
                return {
                    code: objectCode,
                    description: state.objectCodeLookup[objectCode]
                };
            }
            
            return {
                code: objectCode || 'N/A',
                description: 'Unknown Object Code'
            };
        }

        function getBusinessUnitInfo(row) {
            let businessUnitCode = null;
            
            const glString = row['Gl Account String'] || row['Account Number'];
            if (glString) {
                const segments = String(glString).split('.');
                if (segments.length > 0) {
                    // Remove leading zeros to match structure file format
                    businessUnitCode = String(parseInt(segments[0], 10));
                }
            }
            
            if (businessUnitCode && state.businessUnitLookup[businessUnitCode]) {
                return {
                    ...state.businessUnitLookup[businessUnitCode],
                    businessUnitCode: businessUnitCode
                };
            }
            
            return {
                description: 'Unknown Business Unit',
                department: 'Unconfirmed',
                departmentCode: 'N/A',
                businessUnitCode: businessUnitCode || 'N/A'
            };
        }

        async function loadData() {
            try {
                console.log('Loading metro structure...');
                
                const structureResponse = await fetch(CONFIG.METRO_STRUCTURE_URL);
                if (!structureResponse.ok) {
                    throw new Error(`Failed to fetch metro structure: ${structureResponse.status}`);
                }
                
                state.metroStructure = await structureResponse.json();
                buildBusinessUnitLookup();
                buildObjectCodeLookup();
                
                console.log('Loading CSV...');
                const csvResponse = await fetch(CONFIG.CSV_URL);
                
                if (!csvResponse.ok) {
                    throw new Error(`Failed to fetch CSV: ${csvResponse.status}`);
                }
                
                const csvText = await csvResponse.text();
                
                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });

                state.tableData = parsed.data.map(row => {
                    const buInfo = getBusinessUnitInfo(row);
                    const objInfo = getObjectCodeInfo(row);
                    
                    const newRow = {
                        'Department': buInfo.department,
                        'Business Unit Code': buInfo.businessUnitCode,
                        'Business Unit Description': buInfo.description,
                        'Object Code': objInfo.code,
                        'Object Description': objInfo.description
                    };
                    
                    Object.keys(row).forEach(key => {
                        newRow[key] = row[key];
                    });
                    
                    return newRow;
                });

                initializeDashboard();
                displayData();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.style.display = 'block';
                errorDiv.className = 'error';
                errorDiv.innerHTML = `Error: ${error.message}<br><br>Check console for details.`;
            }
        }

        // ======================
        // Dashboard Functions
        // ======================
        function initializeDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Calculate dashboard metrics
            const dates = state.tableData
                .map(row => row['GL Date'] || row['Invoice Date'] || row['Payment Date'])
                .filter(d => d)
                .map(d => new Date(d))
                .sort((a, b) => a - b);
            
            if (dates.length === 0) return;
            
            const firstDate = dates[0];
            const lastDate = dates[dates.length - 1];
            
            // First day transactions
            const firstDayData = state.tableData.filter(row => {
                const rowDate = new Date(row['GL Date'] || row['Invoice Date'] || row['Payment Date']);
                return rowDate.toDateString() === firstDate.toDateString();
            });
            
            // Last day transactions
            const lastDayData = state.tableData.filter(row => {
                const rowDate = new Date(row['GL Date'] || row['Invoice Date'] || row['Payment Date']);
                return rowDate.toDateString() === lastDate.toDateString();
            });
            
            // Calculate totals
            const totalAmount = state.tableData.reduce((sum, row) => sum + (parseFloat(row['Total']) || 0), 0);
            const avgTransaction = totalAmount / state.tableData.length;
            
            // Update dashboard
            document.getElementById('firstDay').textContent = firstDate.toLocaleDateString();
            document.getElementById('firstDayCount').textContent = `${firstDayData.length} transactions`;
            document.getElementById('lastDay').textContent = lastDate.toLocaleDateString();
            document.getElementById('lastDayCount').textContent = `${lastDayData.length} transactions`;
            document.getElementById('totalTransactions').textContent = state.tableData.length.toLocaleString();
            document.getElementById('dateRange').textContent = `${firstDate.toLocaleDateString()} - ${lastDate.toLocaleDateString()}`;
            document.getElementById('dashTotalAmount').textContent = '$' + totalAmount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('avgTransaction').textContent = 'Avg: $' + avgTransaction.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            createCharts();
        }

        function createCharts() {
            // Department spending chart
            const deptSpending = {};
            state.tableData.forEach(row => {
                const dept = row['Department'] || 'Unknown';
                const amount = parseFloat(row['Total']) || 0;
                deptSpending[dept] = (deptSpending[dept] || 0) + amount;
            });
            
            const deptLabels = Object.keys(deptSpending).sort((a, b) => deptSpending[b] - deptSpending[a]).slice(0, 10);
            const deptData = deptLabels.map(label => deptSpending[label]);
            
            const deptCtx = document.getElementById('departmentChart').getContext('2d');
            state.charts.department = new Chart(deptCtx, {
                type: 'bar',
                data: {
                    labels: deptLabels,
                    datasets: [{
                        label: 'Spending by Department',
                        data: deptData,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top 10 Departments by Spending'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
            
            // Daily transactions chart
            const dailyData = {};
            state.tableData.forEach(row => {
                const date = row['GL Date'] || row['Invoice Date'] || row['Payment Date'];
                if (date) {
                    const dateStr = new Date(date).toLocaleDateString();
                    dailyData[dateStr] = (dailyData[dateStr] || 0) + 1;
                }
            });
            
            const dailyLabels = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
            const dailyCounts = dailyLabels.map(label => dailyData[label]);
            
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            state.charts.daily = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Daily Transactions',
                        data: dailyCounts,
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Transactions Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ======================
        // Table Functions
        // ======================
        function displayData() {
            document.getElementById('toolbar').style.display = 'block';
            document.getElementById('stats').style.display = 'flex';
            
            console.log('Creating table with', state.tableData.length, 'rows');

            // Populate filter dropdowns
            populateFilters();

            // Build columns
            const allColumnNames = Object.keys(state.tableData[0]);
            const columns = [];
            
            // Priority columns first
            CONFIG.PRIORITY_COLUMNS.forEach(colName => {
                if (allColumnNames.includes(colName)) {
                    columns.push(createColumnConfig(colName, true));
                }
            });
            
            // Remaining columns (hidden by default)
            allColumnNames.forEach(colName => {
                if (!CONFIG.PRIORITY_COLUMNS.includes(colName)) {
                    columns.push(createColumnConfig(colName, false));
                }
            });

            // Initialize table
            state.table = new Tabulator("#table", {
                data: state.tableData,
                columns: columns,
                layout: "fitDataStretch",
                pagination: true,
                paginationSize: 50,
                movableColumns: true,
                resizableColumns: true,
                initialSort: [
                    {column: "GL Date", dir: "desc"}
                ]
            });

            state.table.on("dataFiltered", updateStats);
            state.table.on("dataLoaded", updateStats);
            
            // Setup event listeners
            setupEventListeners();
            updateStats();
        }

        function createColumnConfig(colName, visible) {
            const config = {
                title: colName,
                field: colName,
                visible: visible,
                headerSort: true
            };
            
            if (CONFIG.AI_COLUMNS.includes(colName)) {
                config.titleFormatter = function(cell) {
                    return `${cell.getValue()} ðŸ¤–`;
                };
            }
            
            if (colName === 'Total' || colName.includes('Amount')) {
                config.formatter = function(cell) {
                    const value = cell.getValue();
                    if (value && !isNaN(value)) {
                        return '$' + parseFloat(value).toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                    return value;
                };
            }
            
            return config;
        }

        function populateFilters() {
            const departments = [...new Set(state.tableData.map(row => row['Department']))].filter(x => x).sort();
            const deptFilter = document.getElementById('deptFilter');
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });

            const businessUnits = [...new Set(state.tableData.map(row => row['Business Unit Description']).filter(x => x))].sort();
            const buFilter = document.getElementById('buFilter');
            businessUnits.forEach(bu => {
                const option = document.createElement('option');
                option.value = bu;
                option.textContent = bu;
                buFilter.appendChild(option);
            });

            const objectCodes = [...new Set(state.tableData.map(row => row['Object Code']).filter(x => x && x !== 'N/A'))].sort();
            const objCodeFilter = document.getElementById('objCodeFilter');
            objectCodes.forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code;
                objCodeFilter.appendChild(option);
            });

            const objectDescriptions = [...new Set(state.tableData.map(row => row['Object Description']).filter(x => x && x !== 'Unknown Object Code'))].sort();
            const objDescFilter = document.getElementById('objDescFilter');
            objectDescriptions.forEach(desc => {
                const option = document.createElement('option');
                option.value = desc;
                option.textContent = desc;
                objDescFilter.appendChild(option);
            });
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('deptFilter').addEventListener('change', applyFilters);
            document.getElementById('buFilter').addEventListener('change', applyFilters);
            document.getElementById('objCodeFilter').addEventListener('change', applyFilters);
            document.getElementById('objDescFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFrom').addEventListener('change', applyFilters);
            document.getElementById('dateTo').addEventListener('change', applyFilters);
            document.getElementById('pageSizeSelect').addEventListener('change', function() {
                state.table.setPageSize(parseInt(this.value));
            });
        }

        function applyFilters() {
            const filters = [];
            let hasActiveFilters = false;
            
            // Search filter
            const searchValue = document.getElementById('searchInput').value.trim();
            if (searchValue) {
                hasActiveFilters = true;
                filters.push(function(data) {
                    const searchLower = searchValue.toLowerCase();
                    return Object.values(data).some(value => {
                        if (value === null || value === undefined) return false;
                        return String(value).toLowerCase().includes(searchLower);
                    });
                });
            }
            
            // Department filter
            const deptValue = document.getElementById('deptFilter').value;
            if (deptValue) {
                filters.push({field: 'Department', type: '=', value: deptValue});
                hasActiveFilters = true;
            }
            
            // Business Unit filter
            const buValue = document.getElementById('buFilter').value;
            if (buValue) {
                filters.push({field: 'Business Unit Description', type: '=', value: buValue});
                hasActiveFilters = true;
            }
            
            // Object Code filter
            const objCodeValue = document.getElementById('objCodeFilter').value;
            if (objCodeValue) {
                filters.push({field: 'Object Code', type: '=', value: objCodeValue});
                hasActiveFilters = true;
            }
            
            // Object Description filter
            const objDescValue = document.getElementById('objDescFilter').value;
            if (objDescValue) {
                filters.push({field: 'Object Description', type: '=', value: objDescValue});
                hasActiveFilters = true;
            }
            
            // Date range filter
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            if (dateFrom || dateTo) {
                hasActiveFilters = true;
                filters.push(function(data) {
                    const dateFields = ['GL Date', 'Invoice Date', 'Payment Date'];
                    
                    for (let field of dateFields) {
                        if (data[field]) {
                            const rowDate = new Date(data[field]);
                            
                            if (dateFrom) {
                                const fromDate = new Date(dateFrom);
                                if (rowDate < fromDate) continue;
                            }
                            
                            if (dateTo) {
                                const toDate = new Date(dateTo);
                                toDate.setHours(23, 59, 59, 999);
                                if (rowDate > toDate) continue;
                            }
                            
                            return true;
                        }
                    }
                    
                    return false;
                });
            }
            
            // Apply filters
            if (filters.length > 0) {
                state.table.setFilter(filters);
            } else {
                state.table.clearFilter();
            }
            
            // Show/hide total amount stat based on active filters
            const totalAmountStat = document.querySelector('.stat-item:nth-child(3)');
            if (totalAmountStat) {
                totalAmountStat.style.display = hasActiveFilters ? 'flex' : 'none';
            }
        }

        function updateStats() {
            const totalRows = state.tableData.length;
            
            let filteredData = [];
            if (state.table.getFilters().length > 0) {
                filteredData = state.table.searchData(state.table.getFilters());
            } else {
                filteredData = state.tableData;
            }
            
            const filteredRows = filteredData.length;
            
            let totalAmount = 0;
            filteredData.forEach(row => {
                const amount = parseFloat(row['Total']) || 0;
                totalAmount += amount;
            });
            
            document.getElementById('totalRows').textContent = totalRows.toLocaleString();
            document.getElementById('filteredRows').textContent = filteredRows.toLocaleString();
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('deptFilter').value = '';
            document.getElementById('buFilter').value = '';
            document.getElementById('objCodeFilter').value = '';
            document.getElementById('objDescFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            state.table.clearFilter();
            
            const totalAmountStat = document.querySelector('.stat-item:nth-child(3)');
            if (totalAmountStat) {
                totalAmountStat.style.display = 'none';
            }
            
            updateStats();
        }

        function toggleAllColumns() {
            state.showingAllColumns = !state.showingAllColumns;
            const btn = document.getElementById('toggleColumns');
            
            if (state.showingAllColumns) {
                const allColumns = state.table.getColumns();
                allColumns.forEach(col => {
                    col.show();
                });
                btn.textContent = 'Show Essential Columns';
                btn.classList.add('active');
            } else {
                const allColumns = state.table.getColumns();
                allColumns.forEach(col => {
                    const field = col.getField();
                    if (!CONFIG.PRIORITY_COLUMNS.includes(field)) {
                        col.hide();
                    }
                });
                btn.textContent = 'Show All Columns';
                btn.classList.remove('active');
            }
        }

        // ======================
        // Export Functions
        // ======================
        function downloadFiltered() {
            const filteredData = state.table.getData("active");
            
            if (filteredData.length === 0) {
                alert('No data to download. Please adjust your filters.');
                return;
            }
            
            const dataWithAsterisk = filteredData.map(row => {
                const newRow = {};
                Object.keys(row).forEach(key => {
                    if (CONFIG.AI_COLUMNS.includes(key)) {
                        newRow[key + ' *'] = row[key];
                    } else {
                        newRow[key] = row[key];
                    }
                });
                return newRow;
            });
            
            const csv = Papa.unparse(dataWithAsterisk);
            
            const deptValue = document.getElementById('deptFilter').value;
            const buValue = document.getElementById('buFilter').value;
            const objCodeValue = document.getElementById('objCodeFilter').value;
            const searchValue = document.getElementById('searchInput').value;
            
            let filename = 'general-fund-expenditures';
            if (deptValue) filename += '-' + deptValue.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            if (buValue) filename += '-' + buValue.substring(0, 40).replace(/[^a-z0-9]/gi, '-').toLowerCase();
            if (objCodeValue) filename += '-' + objCodeValue.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            if (searchValue) filename += '-search';
            filename += '-' + new Date().toISOString().split('T')[0] + '.csv';
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ======================
        // Modal Functions
        // ======================
        function openModal() {
            document.getElementById('aiModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('aiModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ======================
        // Initialize
        // ======================
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
